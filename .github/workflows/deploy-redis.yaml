name: Deploy Redis to EKS

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'The branch, tag or SHA to checkout'
        required: true
        default: 'main'
        type: choice
        options:
        - main
        - develop
        - staging
      appName:
        description: 'Application Name'
        required: true
        default: 'redis-cluster'
        type: string
      environment:
        description: 'Target Environment'
        required: true
        default: 'testnet'
        type: choice
        options:
        - testnet
        - staging
        - production
      imageTag:
        description: 'Docker Image Tag'
        required: true
        default: 'latest'
        type: string
      platform:
        description: 'Target Platform'
        required: true
        default: 'linux/amd64'
        type: string

env:
  CLUSTER_NAME: "redis-eks-cluster"
  REGION: "us-west-2"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.REGION }}

    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig \
          --region ${{ env.REGION }} \
          --name ${{ env.CLUSTER_NAME }}

    - name: Deploy to EKS cluster
      run: |
        # 替换镜像标签
        sed "s|{{IMAGE_TAG}}|${{ inputs.imageTag }}|g" k8s/redis-deployment.yaml > k8s/deployment-ready.yaml
        
        # 应用Kubernetes配置
        kubectl apply -f k8s/redis-configmap.yaml
        kubectl apply -f k8s/deployment-ready.yaml
        kubectl apply -f k8s/redis-service.yaml
        
        # 检查部署状态
        kubectl rollout status deployment/redis --timeout=300s
        
        echo "Redis deployment completed successfully!"

    - name: Verify deployment
      run: |
        kubectl get pods -l app=redis
        kubectl get svc redis-service